name: Deploy Terraform to Azure

on:
  workflow_dispatch:
    inputs:
      destroy:
        description: 'Destruir infraestrutura?'
        required: true
        default: 'false'

permissions:
  id-token: write
  contents: read

jobs:
  validate:
    if: ${{ github.event.inputs.destroy == 'false' }}
    name: üîé Validar Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Login no Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Validar Sintaxe e Plano
        working-directory: infra
        run: |
          export ARM_SUBSCRIPTION_ID=${{ secrets.ARM_SUBSCRIPTION_ID }}
          terraform init
          terraform fmt -check
          terraform validate
          terraform plan -out=tfplan

  deploy:
    if: ${{ github.event.inputs.destroy == 'false' }}
    name: üöÄ Deploy e Configura√ß√£o
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      vm2PublicIP: ${{ steps.output_vm.outputs.vm2_public_ip }}
      adminUsername: ${{ steps.output_vm.outputs.admin_username }}
      resourceGroup: ${{ steps.output_vm.outputs.resource_group }}
      nsgName: ${{ steps.output_vm.outputs.nsg_name }}
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Login no Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Aplicar Terraform
        working-directory: infra
        run: |
          export ARM_SUBSCRIPTION_ID=${{ secrets.ARM_SUBSCRIPTION_ID }}
          terraform init
          terraform apply -auto-approve

      # --------------------------
      # CAPTURA APENAS IP P√öBLICO DA VM2
      # --------------------------
      - name: Capturar Outputs
        id: output_vm
        working-directory: infra
        run: |
          echo "vm2_public_ip=$(terraform output -raw public_ip_address_2)" >> $GITHUB_OUTPUT
          echo "admin_username=$(terraform output -raw Admin_username)" >> $GITHUB_OUTPUT
          echo "resource_group=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
          echo "nsg_name=$(terraform output -raw nsg_name)" >> $GITHUB_OUTPUT

      - name: Definir Vari√°veis de Ambiente
        run: |
          echo "ADMIN_USERNAME=${{ steps.output_vm.outputs.admin_username }}" >> $GITHUB_ENV
          echo "VM2_PUBLIC_IP=${{ steps.output_vm.outputs.vm2_public_ip }}" >> $GITHUB_ENV

      # --------------------------
      # DESATIVAR HOST KEY CHECKING
      # --------------------------
      - name: Disable host key checking
        run: |
          mkdir -p ~/.ssh
          echo "Host *" > ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile=/dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      # --------------------------
      # INSTALAR ANSIBLE NO RUNNER
      # --------------------------
      - name: Instalar Ansible e sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible sshpass

      # --------------------------
      # INVENT√ÅRIO APENAS DA VM2 (IP P√öBLICO)
      # --------------------------
      - name: Criar Invent√°rio Ansible
        run: |
          echo "[vm2]" > inventory
          echo "${{ env.VM2_PUBLIC_IP }} ansible_user=${{ env.ADMIN_USERNAME }} ansible_password=${{ secrets.ADMIN_PASSWORD }}" >> inventory

          echo "Invent√°rio criado:"
          cat inventory

      - name: Executar Playbook Ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          ansible-playbook -i inventory ansible/playbook.yml \
            --extra-vars "ansible_sudo_pass=${{ secrets.ADMIN_PASSWORD }}"

  post-tests:
    if: ${{ github.event.inputs.destroy == 'false' }}
    name: ‚úÖ P√≥s-Testes de Infra
    needs: deploy
    runs-on: ubuntu-latest
    env:
      VM2_PUBLIC_IP: ${{ needs.deploy.outputs.vm2PublicIP }}
      ADMIN_USERNAME: ${{ needs.deploy.outputs.adminUsername }}
      RESOURCE_GROUP: ${{ needs.deploy.outputs.resourceGroup }}
      NSG_NAME: ${{ needs.deploy.outputs.nsgName }}
    steps:
      - name: Login no Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Verificar regra da NSG para porta 8081
        run: |
          result=$(az network nsg rule list \
            --nsg-name "$NSG_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?destinationPortRange=='8081' && access=='Allow']")

          if [ "$result" = "[]" ]; then
            echo "‚ùå Porta 8081 n√£o est√° liberada na NSG!"
            exit 1
          else
            echo "‚úÖ Porta 8081 est√° liberada corretamente na NSG!"
          fi

  destroy:
    if: ${{ github.event.inputs.destroy == 'true' }}
    name: üß® Destruir Infraestrutura
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Login no Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Executar Terraform Destroy
        working-directory: infra
        run: |
          terraform init
          terraform destroy -auto-approve
